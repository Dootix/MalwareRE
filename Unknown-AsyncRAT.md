## Hashes ##
SHA256 - **4c000abca2a926307a6a1d42a27694ebd5668643e4c5ca788cc5f162f8edfe7**

SSDEEP - **3072:n7ctzHXFj7hTwhsoEYBFpAk6uc63iFhT6rqOBKm+FlTtnxogHu8x3O/syJOMRjmJ:5yL**

VirusTotal - https://www.virustotal.com/gui/file/4c000abca2a926307a6a1d42a27694ebd5668643e4c5ca788cc5f162f8edfe72/detection

## Initial script ##
- Appears to be a VBS script.
![image](https://github.com/Dootix/MalwareRE/assets/24233481/791b4974-01b8-42f2-aa6c-7e0e7e677217)

## Analysis ##
![image](https://github.com/Dootix/MalwareRE/assets/24233481/b3947264-cb85-4b99-bea9-bd23a1a17117)

- Two topmost variables encoded in hex, separated by exclamation point.
- They are then converted to int -> then represented as bytes as $bbb and $pe.
- $pe (second hex var) loaded as assembly via Reflection.Assembly from .NET
- `$gss = $YIX.GetType('NewPE.PE' -replace '', '')`: This line retrieves the type named `'NewPE.PE'` from the loaded assembly using reflection.
- $IRW is assigned an Execute method from $gss type.
- $ODW is constructed to point to NET Framework's RegSvcs.exe directory.
- $WYZU is an array with $ODW and $bbb as its elements.
- `$IUWS` is assigned the result of invoking the 'Execute' method from `$gss`, passing `$null` as the instance on which the method should be invoked and an array of parameters contained in `$WYZU`.
- Finally, te script's content is written to "C:\Users\Public\libraries.ps1".

![image](https://github.com/Dootix/MalwareRE/assets/24233481/95b111a0-0edf-4ec6-b419-894c7dfff397)
- Creates a batch script. It first disables echoing of invoked commands.
- Sets ps as powershell.exe
- sets params for PowerShell.
- sets cmd's env variable with file's location -> C:\Users\Public\libraries.bat
- Runs the Powershell with provided parameters above.
- Last line creates the above-described batch file.

![image](https://github.com/Dootix/MalwareRE/assets/24233481/0b0e0100-35f3-4944-bd3e-e3b0010bd9bb)
- First, it creates Wscript.Shell and gets the batch file's path to run it when invoked.
- Creates libraries.vbs script with above params.
- Then, creates COM-object to create a scheduled task.
- Scheduled task is created to run **libraries.vbs(which runs libraries.bat, which runs libraries.ps1)** every 2 minutes.
- Gets the root folder of the task scheduler.
- Sets Task definition as **MicrosoftEdgeUpdate** to masquerade as legitimate process.

![image](https://github.com/Dootix/MalwareRE/assets/24233481/644898bb-bc82-4d53-9d01-652349cc3bc2)

## 1st.exe / $bbb - AsyncClient ##
- AsyncClient.exe - indicates AsyncRAT
- https://any.run/report/3a079d4b9809c32d5797b482253e5909c432cf201dde84feeb55f0087f81abb5/4e7d0063-28db-4812-90ee-37bad4d40e8d
- https://malpedia.caad.fkie.fraunhofer.de/details/win.asyncrat

##  1st.exe / $bbb - ANY.RUN analysis ##
- Connects to **munroe{.}work.gd (185.241.208.184)** - decrypted at runtime
![image](https://github.com/Dootix/MalwareRE/assets/24233481/22bc6b0d-56ab-484f-98c4-f96c80fce146)

- C2 domain munroe{.}work.gd hosts simple Apache server with some contents.
![image](https://github.com/Dootix/MalwareRE/assets/24233481/50ed728b-13d0-4898-b221-67b3eb57b6c9)

## 1st.exe / $bbb - C2 Domain ##
- Txt files containing powershell code of previously analyzed scripts.
![image](https://github.com/Dootix/MalwareRE/assets/24233481/c60abcda-ad7e-448f-9981-df9453f9d575)

- test.txt containing three e-mail addresses - probably used for phishing campaign.
![image](https://github.com/Dootix/MalwareRE/assets/24233481/a23335d3-30b7-4c0e-b124-80a406ee08e1)

## 2nd.exe / $pe - final stage ##
- C# / .NET compiled and it's a DLL file.
![image](https://github.com/Dootix/MalwareRE/assets/24233481/8f699112-8b26-4f99-b7eb-fa89246e726e)

- Masquerading as AVAST installer.
![image](https://github.com/Dootix/MalwareRE/assets/24233481/00c270c8-8223-4f6a-a47b-799d282e9480)

- The file is obfuscated by ConfuserEx.
![image](https://github.com/Dootix/MalwareRE/assets/24233481/9413a81b-d50d-481a-9456-7dfc432c3a14)

- Module constructor runs before actual program's entry point. Code is heavily obfuscated by some kind of UTF encoding.
![image](https://github.com/Dootix/MalwareRE/assets/24233481/61f74fd0-db37-418c-8501-1177d8fc0280)

- Used de4dot tool for cleaning the binary from confuserex's obfuscation successful - methods now visible, however they are still "encrypted" by the Confuser. Next tool will be needed.
![image](https://github.com/Dootix/MalwareRE/assets/24233481/0bca46b9-36c1-4e7a-85ed-4bc1c6989588)

- Decrypted the methods using the "ConfuserEx Static String Decryptor" from here -> https://gitlab.com/The-Real-TechLord/ConfuserEx-Static-String-Decryptor
![image](https://github.com/Dootix/MalwareRE/assets/24233481/42125d60-153d-4118-8654-2f355698ce6c)

-We can now clearly see imports that this DLL is making.
![image](https://github.com/Dootix/MalwareRE/assets/24233481/9930092e-f990-4f83-8766-fb242722063b)
[CreateProcessA]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![ZwUnmapViewOfSection]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![ReadProcessMemory]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![WriteProcessMemory]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![VirtualAllocEx]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![GetThreadContext]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![Wow64GetThreadContext]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![SetThreadContext]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![Wow64SetThreadContext]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![ResumeThread]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![ntdll]!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!![kernel32]

- In the module cctr, setting the call to smethod_1 to NOP (deleting the remaining stuff from Confuser).
![image](https://github.com/Dootix/MalwareRE/assets/24233481/8bdea4ee-17e8-41a0-bfcf-0daa67762c70)

WIP.
















