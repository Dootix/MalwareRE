## NursultanNextgen.exe - ANY.RUN

https://app.any.run/tasks/7532f21b-8fa4-48f5-b80c-a2a5f786ebe0

- Observed sample "NursultanNextgen.exe" - during the ANY.RUN analysis two things are visible instantly:
  1. Creation of "server.exe" in C:\Users\admin\AppData\Local\Temp directory.
  2. Adding "server.exe" to firewall's allowed programs list.
- "server.exe" being marked as njRAT -> https://malpedia.caad.fkie.fraunhofer.de/details/win.njrat

## Sample analysis

- DIE verdict - malware marked as .NET executable. We will have to use dnSpy to analyze the C# code.

![image](https://github.com/Dootix/MalwareRE/assets/24233481/3491eef1-96bd-4cff-bee7-dfdca458fb23)

- Overview of the file - originally named "Stub.exe"

![image](https://github.com/Dootix/MalwareRE/assets/24233481/77d01157-bbf7-4a0a-8477-c34ed44e981d)

- Malware is obfuscated with "Fransesco" namespace.
- main() function - we can see some of the setup that the malware does before invoking Fransesco.ko() (which is a true main function)

![image](https://github.com/Dootix/MalwareRE/assets/24233481/f7447050-31a8-4823-8baa-efe38d86b914)

- What's also interesting here is the ThreadStart function that calls "timy_run", which resembles keylogging activity.

![image](https://github.com/Dootix/MalwareRE/assets/24233481/1a8efc77-fbfc-4d3a-b15d-c07745d401ad)

- Fransesco.ko() snippet.

![image](https://github.com/Dootix/MalwareRE/assets/24233481/52105c53-eb55-4eb5-bcb7-70dc628e8160)

## Fransesco.ko() analysis

- 'text' string variable gets the content of the clipboard.
- Then, this text is written to "\Temp\FransescoPast.txt"
- text2 = 'FRANSESCO"
- text3 = 'Strik'

![image](https://github.com/Dootix/MalwareRE/assets/24233481/3af68203-35d5-4d0d-b00b-8081907dfcb4)

![image](https://github.com/Dootix/MalwareRE/assets/24233481/5800f190-0952-4291-bdef-1a34f3a9690e) is converted from Base64 via ![image](https://github.com/Dootix/MalwareRE/assets/24233481/e99cf80e-0098-4b7d-a645-571b2006a641) and returned as UTF-8 character array. **MzQxOQ== -> 3419**

- flag -> comparison between today's data (converted to numerical value) against value in file located AppData\app.  If greater, then flag = true. Otherwise false.
- 3419 converted to string 2000(?)
- *Encoding.UTF8.GetString(Convert.FromBase64String(Strings.Replace(Strings.Replace("aGFraW0z*i5kZG5zLm5ldA!!", "*", "M", 1, -1, CompareMethod.Binary), "!", "=", 1, -1, CompareMethod.Binary)));* -> asterisk replaced with M -> then !! replaced with == suggesting Base64 encoding -> then converted from Base64 -> then UTF-8 encoded. **The string aGFraW0zMi5kZG5zLm5ldA== is hakim32.ddns.net.**

![image](https://github.com/Dootix/MalwareRE/assets/24233481/66f439a9-d918-4448-b6e9-4263e56e9e3b)

- **exception:**
- **Same as above** - writes to Appdata\\app file with the current date. this time AS STRING. if file already exists, it won't be overwritten.
- string H = "FRANSESCOTI3LjAuFRANSESCOC4x"
- *Fransesco.H = Encoding.UTF8.GetString(Convert.FromBase64String(Strings.Replace(Strings.Replace(Fransesco.H, text2, "M", 1, -1, CompareMethod.Binary), text3, "=", 1, -1, CompareMethod.Binary))); -* this line of code takes Fransesco.H (FRANSESCOTI3LjAuFRANSESCOC4x) string and replaces text2 (which is FRANSESCO string) with M, which equals to MTI3LjAuMC4x.
- Next step is not clear - the malware author didn't provide the inputString parameter; so the replacement won't take place.
- if the result of `Interaction.Command()` is `null`, `flag` will be set to `true`, indicating that the result is indeed `null` and it will set reg value in HKCU. If the result of `Interaction.Command()` is not `null`, then `flag` will be set to `false`  and program will sleep for 5000 ms. This code is commonly used to check whether a method or function call has returned a null value
  
![image](https://github.com/Dootix/MalwareRE/assets/24233481/fdc61c0e-1d3e-4653-b043-df1894a72761)

- If mutex not created, program ends the execution.
- If mutex created, Fransesco.INS(); is invoked.

![image](https://github.com/Dootix/MalwareRE/assets/24233481/6a2be508-858a-4083-a6b4-d81d03a06740)

## Fransesco.INS()

- **Fransesco.Idr** = true && NOT comparing if Temp/server.exe exists, which returns none, which results in double negation -> therefore true. Whole statement is true.
- if flag is true, then check if Temp\server.exe exists.
    1.  if yes - delete the file.
    2.  if not, write data to a new file "server.exe", saves it to \Temp directory and starts the process.

![image](https://github.com/Dootix/MalwareRE/assets/24233481/4ff6bb64-53b6-4dcd-aecc-16f9cf138215)

- We can see that the server.exe is being added as an exception to firewall via "netsh firewall add allowedprogram" command.
- Then, as a persistence mechanism, it writes to the HKLM/HKCU CurrentVersion/Run location in registry to start during system startup.

![image](https://github.com/Dootix/MalwareRE/assets/24233481/36dfa7b6-ae7d-4dc5-9900-e9616225b2cf)

![image](https://github.com/Dootix/MalwareRE/assets/24233481/a76b538e-8bd7-46e6-9d20-4b4b2a924331)

![image](https://github.com/Dootix/MalwareRE/assets/24233481/efa33408-6e5f-43de-b175-446ee147e1dc)

![image](https://github.com/Dootix/MalwareRE/assets/24233481/12d1d7af-2084-4801-b7b1-ffeb00ab3cc5)




























